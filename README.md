# Задание "EEPROM"

*Автор: Зиновчик Олег*

## Разбор прилагаемой библиотеки

К документации прилагается архив с минимумом, позволяющим работать с **EEPROM**. В папке **lib** лежат используемые исходники и заголовочные файлы.

- `main.c` — пример программы, вызывающую функцию проверки EEPROM и собственно предложенных операций над ней. В случае успешной проверки загорается зеленый светодиод, в случае ошибок - синий.
- `i2c_common.h`, `i2c_common.c` — пример библиотеки для работы с шиной I2C, включающий абстракцию, пригодную для большинства устройств, работающих на I2C.
- `i2c_eeprom.h`, `i2c_eeprom.c` — пример библиотеки для работы с EEPROM, использующий выше предложенную абстракцию.

`i2c_eeprom` также предоставляет функцию `EE_TEST()`. Ее предусловия:

- EEPROM — 24LC02;
- SCL и SDA подключены к пинам, которые использует I2C1 (SCL - PB6, SDA - PB7);
- **I2C уже настроен и готов к работе**;
- WP подключен к PB5;
- A0-2 заземлены.

Пример подключения:

![Пример подключения EEPROM](png/connection.png "Пример подключения EEPROM; фото: Токарев Андрей")

Собственно, функция `EE_TEST()` последовательно проверяет:

- побайтово (запись + чтение для проверки);
- постранично (запись + чтение для проверки);
- чтением «текущего адреса» начиная с первого байта для проверки;

и возвращает количество ошибок (несовпадений того, что записали, и того, что прочитали).

Рекомендую *самостоятельно* разобраться с собственно реализацией функционала, так как это поможет закрепить принципы работы как с I2C, так и с EEPROM, а также решить следующие задачи.

>**Обратите внимание**: в make-файле по умолчанию для прошивки (вызова `make flash`) вызывается команда `openocd`. Если вы прошиваете с помощью `st-flash`, отредактируйте make-файл примерно на строке 86:
>
>- закомментируйте строку	`openocd -f interface/stlink...`;
>- раскомментируйте строку	`st-flash write $(PROJECT).bin 0x08000000`.

## Уровень 1

1. Подключите EEPROM так, как показано на фотографии. Функция белых проводов на ней - заземление Vss и A0-2. Соберите приложенный проект и прошейте им STM32. Убедитесь в том, что загорелся зеленый светодиод. Если в течение более чем 5 секунд ни один из светодиодов не загорается, убедитесь в правильности подключения и заземления и в том, что питание от трех вольт.
2. Заземлите выход WP EEPROM и выполните проверку. Объясните отсутствие различий с предыдущим пунктом.
3. Подайте на WP питание (то же, что и на Vss) и выполните проверку. Объясните, почему загорелся синий светодиод.

## Уровень 2

Напишите программу, складывающую N матриц размером 3x3 из элементов типа char (1 байт). Требования:

- **Сначала** N матриц  (можно генерировать их как угодно, лишь бы можно было проверить правильность результата) записываются в EEPROM; передавать их EEPROM побайтово запрещено.
- Только **после этого** программа начинает последовательно складывать матрицы одна за другой. Промежуточные результаты записывать в EEPROM не обязательно.

Складываемые матрицы и результат сложения выведите с помощью `xprintf`.

Перед выполнением задачи подумайте, с какой проблемой вы столкнетесь во время реализации. Напишите функцию, решающую эту проблему, тем самым значительно упрощая дальнейшее использование EEPROM.

## Уровень 3

Все задержки (вспомните, где и зачем они необходимы) в приложенной библиотеке реализованы вызовом `delay`, который в цикле исполняет ассембреные команды `nop`. Объясните, почему это плохо, и приведите случаи, в которых это может привести к зависанию исполнения программы. Реализуйте эти задержки с помощью таймеров.

## Уровень 4

Освойте DMA с использованием EEPROM и шины I2C.
